#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <time.h>

// 生成当前时间字符串（用于日志）
char* get_current_time() {
    static char time_str[20];
    time_t now = time(NULL);
    struct tm* tm_info = localtime(&now);
    strftime(time_str, sizeof(time_str), "%Y-%m-%d %H:%M:%S", tm_info);
    return time_str;
}

void exploit(const char* target, int port) {
    int sock = socket(AF_INET, SOCK_STREAM, 0);
    if (sock < 0) {
        // 日志输出：失败信息
        printf("[%s] 访问失败 - 无法创建socket：%s\n", get_current_time(), strerror(errno));
        return;
    }
    
    struct sockaddr_in server_addr;
    memset(&server_addr, 0, sizeof(server_addr));
    server_addr.sin_family = AF_INET;
    server_addr.sin_port = htons(port);
    
    // 解析IP地址（支持域名，增强兼容性）
    if (inet_pton(AF_INET, target, &server_addr.sin_addr) <= 0) {
        printf("[%s] 访问失败 - 无效IP地址：%s\n", get_current_time(), target);
        close(sock);
        return;
    }
    
    // 发起连接（超时设置为5秒）
    struct timeval timeout = {5, 0};
    setsockopt(sock, SOL_SOCKET, SO_SNDTIMEO, &timeout, sizeof(timeout));
    setsockopt(sock, SOL_SOCKET, SO_RCVTIMEO, &timeout, sizeof(timeout));
    
    if (connect(sock, (struct sockaddr*)&server_addr, sizeof(server_addr)) < 0) {
        printf("[%s] 访问失败 - 无法连接 %s:%d：%s\n", get_current_time(), target, port, strerror(errno));
        close(sock);
        return;
    }
    
    // 访问成功日志
    printf("[%s] 访问成功 - 已连接 %s:%d\n", get_current_time(), target, port);
    close(sock);
}